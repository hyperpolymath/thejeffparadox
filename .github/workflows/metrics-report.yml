# Metrics Report
# Generates periodic metrics reports for the conversation

name: Metrics Report

on:
  schedule:
    # Daily at midnight
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  report:
    name: Generate Report
    runs-on: ubuntu-latest

    # Only run if conversation is active
    if: ${{ vars.CONVERSATION_ENABLED == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: "1.10"

      - name: Cache Julia packages
        uses: julia-actions/cache@v1

      - name: Install dependencies
        run: |
          cd engine
          julia --project=. -e 'using Pkg; Pkg.instantiate()'

      - name: Generate metrics report
        id: metrics
        run: |
          cd engine
          julia --project=. -e '
            using JeffEngine
            using Dates

            config_path = joinpath(dirname(@__DIR__), "orchestrator", "data", "game_state.yml")

            if !isfile(config_path)
                println("No game state found")
                exit(0)
            end

            game = load_game_state(config_path, Dict())

            # Generate report
            report = """
            # The Jeff Paradox - Metrics Report

            Generated: $(Dates.format(now(), "yyyy-mm-dd HH:MM:SS UTC"))

            ## Game State

            | Metric | Value |
            |--------|-------|
            | Turn | $(game.turn_number) |
            | Chaos | $(game.chaos)/100 |
            | Exposure | $(game.exposure)/100 |
            | Faction | $(game.faction_slider) |

            ## Current Metrics

            $(metrics_summary(game))

            ## Threshold Status

            $(let events = check_thresholds(game.chaos, game.exposure, game.faction_slider)
                isempty(events) ? "No thresholds triggered" : join(["- $(e)" for e in events], "\n")
            end)

            ## Convergence Analysis

            $(let warning = convergence_warning(game)
                warning === nothing ? "Convergence levels normal" : warning
            end)

            ## Pattern Quarantine

            $(isempty(game.pattern_quarantine) ? "No patterns quarantined" :
                join(["- \"$(p)\"" for p in game.pattern_quarantine[max(1,end-9):end]], "\n"))
            """

            # Save report
            report_path = joinpath(dirname(@__DIR__), "docs", "reports", "daily-$(Dates.format(now(), "yyyy-mm-dd")).md")
            mkpath(dirname(report_path))
            write(report_path, report)

            println(report)
          '

      - name: Commit report
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/reports/
          git diff --staged --quiet || git commit -m "docs: daily metrics report [automated]"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Create summary
        run: |
          echo "## Daily Metrics Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat docs/reports/daily-$(date +%Y-%m-%d).md >> $GITHUB_STEP_SUMMARY || echo "Report not generated"
