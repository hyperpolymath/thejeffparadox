# Repository Maintenance - Robot Repo Cleaner
# Automated cleanup of artifacts, branches, caches, and containers
# RSR Compliant: SHA-pinned actions

name: Repo Maintenance

on:
  schedule:
    # Run weekly on Sunday at 2am UTC
    - cron: "0 2 * * 0"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (show what would be deleted)"
        type: boolean
        default: true
      clean_artifacts:
        description: "Clean old artifacts"
        type: boolean
        default: true
      clean_branches:
        description: "Clean merged/stale branches"
        type: boolean
        default: true
      clean_caches:
        description: "Clean old caches"
        type: boolean
        default: true
      artifact_retention_days:
        description: "Artifact retention (days)"
        type: number
        default: 30
      branch_staleness_days:
        description: "Branch staleness threshold (days)"
        type: number
        default: 90

permissions:
  contents: write
  actions: write

env:
  DRY_RUN: ${{ inputs.dry_run || 'false' }}

jobs:
  # ==========================================================================
  # Clean Old Artifacts
  # ==========================================================================
  clean-artifacts:
    name: Clean Artifacts
    runs-on: ubuntu-latest
    if: ${{ inputs.clean_artifacts != false }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Clean old artifacts
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const retentionDays = ${{ inputs.artifact_retention_days || 30 }};
            const dryRun = ${{ env.DRY_RUN }};
            const cutoffDate = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000);

            console.log(`Cleaning artifacts older than ${retentionDays} days (cutoff: ${cutoffDate.toISOString()})`);
            console.log(`Dry run: ${dryRun}`);

            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            let deleted = 0;
            let skipped = 0;

            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoffDate) {
                console.log(`${dryRun ? '[DRY RUN] Would delete' : 'Deleting'}: ${artifact.name} (${artifact.id}) created ${artifact.created_at}`);
                if (!dryRun) {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                }
                deleted++;
              } else {
                skipped++;
              }
            }

            console.log(`\nSummary: ${deleted} artifacts ${dryRun ? 'would be ' : ''}deleted, ${skipped} retained`);

  # ==========================================================================
  # Clean Merged/Stale Branches
  # ==========================================================================
  clean-branches:
    name: Clean Branches
    runs-on: ubuntu-latest
    if: ${{ inputs.clean_branches != false }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Clean merged branches
        run: |
          DRY_RUN="${{ env.DRY_RUN }}"
          STALENESS_DAYS="${{ inputs.branch_staleness_days || 90 }}"

          echo "Cleaning branches (dry_run=$DRY_RUN, staleness=$STALENESS_DAYS days)"
          echo "=================================================="

          # Protected branches
          PROTECTED="main|master|develop|release|production"

          # Get all remote branches
          git fetch --all --prune

          # Find merged branches (except protected)
          echo -e "\n### Merged branches:"
          MERGED=$(git branch -r --merged origin/main | grep -vE "origin/(HEAD|$PROTECTED)" | sed 's/origin\///' || true)

          for branch in $MERGED; do
            if [ -n "$branch" ]; then
              echo "  - $branch (merged)"
              if [ "$DRY_RUN" != "true" ]; then
                git push origin --delete "$branch" 2>/dev/null || echo "    (already deleted or protected)"
              fi
            fi
          done

          # Find stale branches (no commits in X days)
          echo -e "\n### Stale branches (no activity in $STALENESS_DAYS days):"
          CUTOFF=$(date -d "$STALENESS_DAYS days ago" +%s 2>/dev/null || date -v-${STALENESS_DAYS}d +%s)

          for branch in $(git branch -r | grep -vE "origin/(HEAD|$PROTECTED)" | sed 's/origin\///'); do
            LAST_COMMIT=$(git log -1 --format=%ct "origin/$branch" 2>/dev/null || echo "0")
            if [ "$LAST_COMMIT" -lt "$CUTOFF" ] && [ "$LAST_COMMIT" != "0" ]; then
              LAST_DATE=$(git log -1 --format=%ci "origin/$branch" 2>/dev/null || echo "unknown")
              echo "  - $branch (last commit: $LAST_DATE)"
              # Don't auto-delete stale branches, just report
            fi
          done

          echo -e "\n### Summary"
          echo "Merged branches processed: $(echo "$MERGED" | wc -w)"

  # ==========================================================================
  # Clean GitHub Actions Caches
  # ==========================================================================
  clean-caches:
    name: Clean Caches
    runs-on: ubuntu-latest
    if: ${{ inputs.clean_caches != false }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Clean old caches
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const dryRun = ${{ env.DRY_RUN }};
            const retentionDays = 14; // Caches older than 2 weeks
            const cutoffDate = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000);

            console.log(`Cleaning caches older than ${retentionDays} days`);
            console.log(`Dry run: ${dryRun}`);

            try {
              const caches = await github.rest.actions.getActionsCacheList({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });

              let deleted = 0;
              let retained = 0;
              let totalSize = 0;

              for (const cache of caches.data.actions_caches) {
                const createdAt = new Date(cache.created_at);
                totalSize += cache.size_in_bytes;

                if (createdAt < cutoffDate) {
                  console.log(`${dryRun ? '[DRY RUN] Would delete' : 'Deleting'}: ${cache.key} (${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB)`);
                  if (!dryRun) {
                    await github.rest.actions.deleteActionsCacheById({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      cache_id: cache.id
                    });
                  }
                  deleted++;
                } else {
                  retained++;
                }
              }

              console.log(`\nSummary:`);
              console.log(`  - Total caches: ${caches.data.total_count}`);
              console.log(`  - Total size: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
              console.log(`  - ${dryRun ? 'Would delete' : 'Deleted'}: ${deleted}`);
              console.log(`  - Retained: ${retained}`);
            } catch (error) {
              console.log('Cache API not available or no caches found');
            }

  # ==========================================================================
  # Repository Health Report
  # ==========================================================================
  health-report:
    name: Health Report
    runs-on: ubuntu-latest
    needs: [clean-artifacts, clean-branches, clean-caches]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Generate health report
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { execSync } = require('child_process');

            // Get repo stats
            const commits = execSync('git rev-list --count HEAD').toString().trim();
            const branches = execSync('git branch -r | wc -l').toString().trim();
            const contributors = execSync('git shortlog -sn --all | wc -l').toString().trim();
            const lastCommit = execSync('git log -1 --format=%ci').toString().trim();

            // Get open issues/PRs count
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 1
            });

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 1
            });

            // Create summary
            const summary = `
            ## ðŸ¤– Repository Health Report

            **Generated**: ${new Date().toISOString()}

            ### Repository Stats
            | Metric | Value |
            |--------|-------|
            | Total Commits | ${commits} |
            | Remote Branches | ${branches} |
            | Contributors | ${contributors} |
            | Last Commit | ${lastCommit} |
            | Open Issues | ~${issues.headers['x-total-count'] || '?'} |
            | Open PRs | ~${prs.headers['x-total-count'] || '?'} |

            ### Maintenance Status
            - âœ… Artifact cleanup: ${{ needs.clean-artifacts.result }}
            - âœ… Branch cleanup: ${{ needs.clean-branches.result }}
            - âœ… Cache cleanup: ${{ needs.clean-caches.result }}

            ### Next Steps
            - Review stale branches manually if needed
            - Check for any failed workflows
            - Ensure secrets are up to date
            `;

            await core.summary.addRaw(summary).write();
